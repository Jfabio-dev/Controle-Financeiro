<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Controle Financeiro Elite v12</title>
    <style>
        :root {
            --primary: #1a73e8; --danger: #e74c3c; --success: #2ecc71; --warning: #f39c12; --dark: #2c3e50;
        }
        body { font-family: 'Segoe UI', sans-serif; background: #f0f2f5; display: flex; justify-content: center; padding: 20px; margin: 0; }
        .container { background: white; padding: 20px; border-radius: 16px; box-shadow: 0 8px 30px rgba(0,0,0,0.1); width: 100%; max-width: 450px; }
        .header-date { text-align: center; color: var(--primary); font-weight: bold; margin-bottom: 15px; text-transform: capitalize; }
        .progress-container { background: #eee; border-radius: 10px; height: 12px; margin: 15px 0; overflow: hidden; }
        #progressBar { height: 100%; background: var(--success); width: 0%; transition: 0.5s; }
        .setup-box { background: #f8f9fa; padding: 15px; border-radius: 12px; margin-bottom: 20px; border: 1px solid #eef0f2; }
        .card { padding: 12px; border-radius: 10px; background: #fff; border: 1px solid #eee; text-align: center; margin-bottom: 10px; }
        .card small { display: block; font-size: 0.65rem; color: #666; text-transform: uppercase; font-weight: bold; }
        .card strong { font-size: 1.1rem; display: block; }
        .balance-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .meta-card { border-top: 4px solid var(--primary); background: #e3f2fd; }
        .spent-today-card { border-top: 4px solid var(--warning); }
        input, select { width: 100%; padding: 12px; margin: 6px 0; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; }
        .btn { width: 100%; padding: 12px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; margin-top: 8px; }
        .btn-add { background: var(--primary); color: white; }
        .category-summary { font-size: 0.8rem; background: #fff; padding: 10px; border-radius: 10px; border: 1px solid #eee; margin: 15px 0; }
        .category-item { display: flex; justify-content: space-between; border-bottom: 1px dashed #eee; padding: 2px 0; }
        ul { list-style: none; padding: 0; }
        li { background: #fff; padding: 12px; border-bottom: 1px solid #f0f0f0; display: flex; justify-content: space-between; align-items: center; font-size: 0.85rem; }
        .del-btn { background: #fee2e2; border: none; color: var(--danger); border-radius: 50%; width: 24px; height: 24px; cursor: pointer; }
        #reportArea { display: none; background: #1a1a1a; color: #00ff41; padding: 15px; margin-top: 15px; font-family: monospace; white-space: pre-wrap; border-radius: 8px; font-size: 0.75rem; }
        .neg { color: var(--danger); } .pos { color: var(--success); }
    </style>
</head>
<body>

<div class="container">
    <div class="header-date" id="dateDisplay"></div>

    <div class="setup-box">
        <div style="display: flex; gap: 10px;">
            <div style="flex: 1;"><small>Aporte:</small><input type="number" id="budgetInput" oninput="updateUI()"></div>
            <div style="flex: 1;"><small>Dias:</small><input type="number" id="daysInput" oninput="updateUI()"></div>
        </div>
        <input type="date" id="startDateInput" oninput="updateUI()">
    </div>

    <div class="card">
        <small>Saldo Restante</small>
        <strong id="totalBalance">R$ 0,00</strong>
        <div class="progress-container"><div id="progressBar"></div></div>
    </div>

    <div class="balance-grid">
        <div class="card meta-card"><small>Meta Hoje</small><strong id="dailyGoal">R$ 0,00</strong></div>
        <div class="card spent-today-card" id="todayCard"><small>Gasto Hoje</small><strong id="spentToday">R$ 0,00</strong></div>
    </div>

    <div class="category-summary" id="catSummary"></div>

    <div class="setup-box">
        <input type="text" id="desc" placeholder="Descrição">
        <div style="display: flex; gap: 5px;">
            <input type="number" id="amount" placeholder="Valor">
            <select id="categorySelect">
                <option value="Alimentação">Alimentação</option>
                <option value="Lazer">Lazer</option>
                <option value="Transporte">Transporte</option>
                <option value="Saúde">Saúde</option>
                <option value="Essencial">Essencial</option>
                <option value="Outros">Outros</option>
            </select>
        </div>
        <input type="date" id="transDate">
        <button class="btn btn-add" onclick="addTrans()">Salvar Gasto</button>
    </div>

    <h4 id="listTitle" style="margin: 10px 0 5px 0; font-size: 0.9rem; color: #666;">Gastos de Hoje</h4>
    <ul id="list"></ul>
    <button id="btnHistory" class="btn" style="background: #eee; color: #666; font-size: 0.8rem; display: none;" onclick="toggleHistory()">Ver Histórico Completo</button>

    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px;">
        <button class="btn" style="background: #27ae60; color: white;" onclick="exportCSV()">CSV</button>
        <button class="btn" style="background: var(--dark); color: white;" onclick="toggleReport()">Extrato</button>
    </div>
    <button class="btn" style="background: #fdfdfd; color: #999; font-size: 0.7rem;" onclick="resetApp()">Zerar Sistema</button>

    <div id="reportArea"></div>
</div>

<script>
    let transactions = JSON.parse(localStorage.getItem('financas_v10')) || [];
    let showFullHistory = false; // Estado do filtro
    const formatter = new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' });
    const hojeStr = new Date().toISOString().split('T')[0];
    const hojeDate = new Date(); hojeDate.setHours(0,0,0,0);

    // Init inputs
    document.getElementById('startDateInput').value = localStorage.getItem('startDate') || hojeStr;
    document.getElementById('budgetInput').value = localStorage.getItem('budget') || '';
    document.getElementById('daysInput').value = localStorage.getItem('days') || '';
    document.getElementById('transDate').value = hojeStr;

    function updateUI() {
        // ... (mantenha a parte inicial de cálculos de saldo e meta igual) ...
        document.getElementById('dateDisplay').innerText = hojeDate.toLocaleDateString('pt-BR', {weekday:'long', day:'numeric', month:'long'});
        
        const budget = parseFloat(document.getElementById('budgetInput').value) || 0;
        const totalDays = parseInt(document.getElementById('daysInput').value) || 1;
        const startDate = new Date(document.getElementById('startDateInput').value + 'T00:00:00');

        localStorage.setItem('budget', budget);
        localStorage.setItem('days', totalDays);
        localStorage.setItem('startDate', document.getElementById('startDateInput').value);

        let totalGeral = 0, gastosAteOntem = 0, gastosHoje = 0;
        let cats = {};

        transactions.forEach(t => {
            const val = parseFloat(t.amount);
            totalGeral += val;
            if (t.date < hojeStr) gastosAteOntem += val;
            else if (t.date === hojeStr) gastosHoje += val;
            cats[t.category] = (cats[t.category] || 0) + val;
        });

        document.getElementById('totalBalance').innerText = formatter.format(budget - totalGeral);
        document.getElementById('dailyGoal').innerText = formatter.format(Math.max(0, (budget - gastosAteOntem) / Math.max(1, totalDays - Math.floor((hojeDate - startDate) / 86400000))));
        document.getElementById('spentToday').innerText = formatter.format(gastosHoje);

        // --- NOVA LÓGICA DE LISTA CORRIGIDA ---
        const listEl = document.getElementById('list');
        const btnH = document.getElementById('btnHistory');
        const listTitle = document.getElementById('listTitle');
        listEl.innerHTML = '';

        // 1. Filtrar transações
        let filtradas = [];
        if (showFullHistory) {
            // No modo histórico, pegamos TUDO
            filtradas = [...transactions];
            listTitle.innerText = "Histórico Completo";
        } else {
            // No modo padrão, APENAS hoje
            filtradas = transactions.filter(t => t.date === hojeStr);
            listTitle.innerText = "Gastos de Hoje";
        }

        // 2. Ordenar por data e hora (mais recentes primeiro)
        // Dica: Se quiser precisão total, as transações precisariam de 'timestamp', 
        // mas aqui ordenamos pela data.
        filtradas.sort((a, b) => new Date(b.date) - new Date(a.date));

        // 3. Aplicar o limite de 10 itens APENAS se houver muitos itens, 
        // para não esconder o dia anterior quando o histórico for ativado.
        const exibir = filtradas.slice(0, 15); // Aumentei para 15 para dar mais fôlego visual

        exibir.forEach(t => {
            const idx = transactions.indexOf(t);
            const li = document.createElement('li');
            li.innerHTML = `
                <div><b>${t.desc}</b><br><small>${t.category} | ${t.date.split('-').reverse().slice(0,2).join('/')}</small></div>
                <div><b>${formatter.format(t.amount)}</b> <button class="del-btn" onclick="removeTrans(${idx})">✕</button></div>
            `;
            listEl.appendChild(li);
        });

        // 4. Botão de Histórico Inteligente
        const temAntigos = transactions.some(t => t.date !== hojeStr);
        if (temAntigos) {
            btnH.style.display = 'block';
            btnH.innerText = showFullHistory ? "Ver apenas hoje" : "Ver gastos anteriores";
        } else {
            btnH.style.display = 'none';
        }

        if (exibir.length === 0) {
            listEl.innerHTML = '<li style="color:#999; justify-content:center;">Nenhum gasto hoje.</li>';
        }

        localStorage.setItem('financas_v10', JSON.stringify(transactions));
    }

    function toggleHistory() {
        showFullHistory = !showFullHistory;
        updateUI();
    }

    function addTrans() {
        const desc = document.getElementById('desc').value;
        const amount = parseFloat(document.getElementById('amount').value);
        const category = document.getElementById('categorySelect').value;
        const date = document.getElementById('transDate').value;
        if (desc && amount) {
            transactions.push({ desc, amount, category, date });
            document.getElementById('desc').value = '';
            document.getElementById('amount').value = '';
            updateUI();
        }
    }

    function removeTrans(index) {
        if(confirm("Excluir?")) { transactions.splice(index, 1); updateUI(); }
    }

    function toggleReport() {
        const area = document.getElementById('reportArea');
        area.style.display = area.style.display === 'block' ? 'none' : 'block';
        if (area.style.display === 'block') {
            let total = 0;
            let res = "=== EXTRATO COMPLETO ===\n\n";
            transactions.sort((a,b)=>new Date(a.date)-new Date(b.date)).forEach(t => {
                res += `${t.date.split('-').reverse().join('/')} ${t.desc.padEnd(12)} ${formatter.format(t.amount)}\n`;
                total += t.amount;
            });
            res += `\nTOTAL GASTO: ${formatter.format(total)}`;
            area.innerText = res;
        }
    }

    function exportCSV() {
        let csv = "Data;Descricao;Valor\n";
        transactions.forEach(t => csv += `${t.date};${t.desc};${t.amount}\n`);
        const blob = new Blob([csv], { type: 'text/csv' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'financas.csv';
        a.click();
    }

    function resetApp() {
        if(confirm("Zerar tudo?")) { localStorage.clear(); location.reload(); }
    }

    updateUI();
</script>
</body>
</html>
