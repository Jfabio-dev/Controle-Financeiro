<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Controle Financeiro Elite v12.2</title>
    <style>
        :root {
            --primary: #1a73e8; --danger: #e74c3c; --success: #2ecc71; --warning: #f39c12; --dark: #2c3e50;
        }
        body { font-family: 'Segoe UI', sans-serif; background: #f0f2f5; display: flex; justify-content: center; padding: 15px; margin: 0; }
        .container { background: white; padding: 20px; border-radius: 16px; box-shadow: 0 8px 30px rgba(0,0,0,0.1); width: 100%; max-width: 450px; }
        
        .header-date { text-align: center; color: var(--primary); font-weight: bold; margin-bottom: 15px; text-transform: capitalize; font-size: 1.1rem; }
        
        .setup-box { background: #f8f9fa; padding: 15px; border-radius: 12px; margin-bottom: 15px; border: 1px solid #eef0f2; }
        
        .card { padding: 12px; border-radius: 10px; background: #fff; border: 1px solid #eee; text-align: center; margin-bottom: 10px; }
        .card small { display: block; font-size: 0.65rem; color: #666; text-transform: uppercase; font-weight: bold; }
        .card strong { font-size: 1.2rem; display: block; }
        
        .progress-container { background: #eee; border-radius: 10px; height: 8px; margin-top: 10px; overflow: hidden; }
        #progressBar { height: 100%; background: var(--success); width: 0%; transition: 0.5s; }

        .balance-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        .meta-card { border-top: 4px solid var(--primary); background: #f0f7ff; }
        .spent-today-card { border-top: 4px solid var(--warning); }
        
        .alert-danger { background: #fff1f0 !important; border-top-color: var(--danger) !important; }

        input, select { width: 100%; padding: 12px; margin: 5px 0; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 0.9rem; }
        
        .btn { width: 100%; padding: 12px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; transition: 0.2s; }
        .btn-add { background: var(--primary); color: white; margin-top: 10px; }
        
        /* Estilo para Gerenciamento de Categorias */
        .cat-manager { border-top: 1px solid #eee; padding-top: 10px; margin-top: 10px; display: none; }
        .cat-list-item { display: flex; justify-content: space-between; align-items: center; background: #eee; padding: 5px 10px; border-radius: 5px; margin-bottom: 5px; font-size: 0.8rem; }
        
        .category-summary { font-size: 0.8rem; background: #fff; padding: 12px; border-radius: 10px; border: 1px solid #eee; margin-bottom: 15px; }
        .category-item { display: flex; justify-content: space-between; border-bottom: 1px dashed #eee; padding: 4px 0; }

        ul { list-style: none; padding: 0; margin: 0; }
        li { background: #fff; padding: 12px; border-bottom: 1px solid #f0f0f0; display: flex; justify-content: space-between; align-items: center; font-size: 0.85rem; }
        .del-btn { background: #fee2e2; border: none; color: var(--danger); border-radius: 50%; width: 26px; height: 26px; cursor: pointer; }
        
        #reportArea { display: none; background: #1a1a1a; color: #00ff41; padding: 15px; margin-top: 15px; font-family: monospace; white-space: pre-wrap; border-radius: 8px; font-size: 0.75rem; }
        
        .neg { color: var(--danger); font-weight: bold; }
        .pos { color: var(--success); font-weight: bold; }
    </style>
</head>
<body>

<div class="container">
    <div class="header-date" id="dateDisplay"></div>

    <div class="setup-box">
        <div style="display: flex; gap: 10px;">
            <div style="flex: 1;"><small>Aporte:</small><input type="number" id="budgetInput" oninput="updateUI()"></div>
            <div style="flex: 1;"><small>Dias:</small><input type="number" id="daysInput" oninput="updateUI()"></div>
        </div>
        <input type="date" id="startDateInput" oninput="updateUI()">
    </div>

    <div class="card">
        <small>Saldo Restante</small>
        <strong id="totalBalance">R$ 0,00</strong>
        <div class="progress-container"><div id="progressBar"></div></div>
    </div>

    <div class="balance-grid">
        <div class="card meta-card"><small>Meta Hoje</small><strong id="dailyGoal">R$ 0,00</strong></div>
        <div id="todayCard" class="card spent-today-card"><small>Gasto Hoje</small><strong id="spentToday">R$ 0,00</strong></div>
    </div>

    <div class="category-summary" id="catSummary"></div>

    <div class="setup-box">
        <input type="text" id="desc" placeholder="Descrição">
        <div style="display: flex; gap: 5px;">
            <input type="number" id="amount" placeholder="Valor">
            <select id="categorySelect"></select>
        </div>
        <input type="date" id="transDate">
        <button class="btn btn-add" onclick="addTrans()">Salvar Gasto</button>
        
        <button onclick="toggleCatManager()" style="background:none; border:none; color:var(--primary); font-size:0.7rem; cursor:pointer; width:100%; margin-top:10px; text-decoration:underline;">
            Gerenciar Categorias de Gasto
        </button>

        <div id="catManager" class="cat-manager">
            <div style="display:flex; gap:5px;">
                <input type="text" id="newCatInput" placeholder="Nova Categoria..." style="padding:8px;">
                <button class="btn" style="width:auto; margin:5px 0; background:var(--success); color:white; padding:0 15px;" onclick="addCategory()">+</button>
            </div>
            <div id="catList"></div>
        </div>
    </div>

    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
        <h4 id="listTitle" style="margin: 0; font-size: 0.9rem; color: #666;">Gastos de Hoje</h4>
        <button id="btnHistory" style="background: none; border: none; color: var(--primary); font-size: 0.75rem; cursor: pointer;" onclick="toggleHistory()">Ver anteriores</button>
    </div>
    <ul id="list"></ul>

    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px;">
        <button class="btn" style="background: #27ae60; color: white;" onclick="exportCSV()">CSV</button>
        <button class="btn" style="background: var(--dark); color: white;" onclick="toggleReport()">Extrato</button>
    </div>
    
    <button class="btn" style="background: transparent; color: #999; font-size: 0.7rem; margin-top: 10px;" onclick="resetApp()">Zerar Sistema</button>

    <div id="reportArea"></div>
</div>

<script>
    // Carrega dados ou define padrões
    let transactions = JSON.parse(localStorage.getItem('financas_v10')) || [];
    let categories = JSON.parse(localStorage.getItem('cats_v10')) || ["Alimentação", "Lazer", "Transporte", "Saúde", "Essencial", "Outros"];
    let showFullHistory = false;
    
    const formatter = new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' });
    const getHojeStr = () => new Date().toLocaleDateString('en-CA');
    const hojeStr = getHojeStr();
    const hojeDate = new Date(hojeStr + 'T00:00:00');

    // Inicialização
    document.getElementById('startDateInput').value = localStorage.getItem('startDate') || hojeStr;
    document.getElementById('budgetInput').value = localStorage.getItem('budget') || '';
    document.getElementById('daysInput').value = localStorage.getItem('days') || '';
    document.getElementById('transDate').value = hojeStr;

    function updateUI() {
        document.getElementById('dateDisplay').innerText = hojeDate.toLocaleDateString('pt-BR', {weekday:'long', day:'numeric', month:'long'});
        
        // Atualiza Select e Lista de Gerenciamento
        const select = document.getElementById('categorySelect');
        const catList = document.getElementById('catList');
        select.innerHTML = categories.map(c => `<option value="${c}">${c}</option>`).join('');
        catList.innerHTML = categories.map((c, i) => `
            <div class="cat-list-item">
                ${c} <button onclick="removeCategory(${i})" style="border:none; background:none; color:var(--danger); cursor:pointer;">✕</button>
            </div>
        `).join('');

        const budget = parseFloat(document.getElementById('budgetInput').value) || 0;
        const totalDays = parseInt(document.getElementById('daysInput').value) || 1;
        const startDate = new Date(document.getElementById('startDateInput').value + 'T00:00:00');

        localStorage.setItem('budget', budget);
        localStorage.setItem('days', totalDays);
        localStorage.setItem('startDate', document.getElementById('startDateInput').value);
        localStorage.setItem('cats_v10', JSON.stringify(categories));

        let totalGeral = 0, gastosAteOntem = 0, gastosHoje = 0;
        let catsCount = {};

        transactions.forEach(t => {
            const val = parseFloat(t.amount);
            totalGeral += val;
            if (t.date < hojeStr) gastosAteOntem += val;
            else if (t.date === hojeStr) gastosHoje += val;
            catsCount[t.category] = (catsCount[t.category] || 0) + val;
        });

        // Cálculos
        const diffMs = hojeDate - startDate;
        const daysPassed = Math.floor(diffMs / 86400000);
        const daysRemaining = Math.max(1, totalDays - daysPassed);
        const metaHoje = Math.max(0, (budget - gastosAteOntem) / daysRemaining);
        const saldo = budget - totalGeral;

        document.getElementById('totalBalance').innerText = formatter.format(saldo);
        document.getElementById('totalBalance').className = saldo < 0 ? 'neg' : 'pos';
        document.getElementById('dailyGoal').innerText = formatter.format(metaHoje);
        document.getElementById('spentToday').innerText = formatter.format(gastosHoje);

        // Alerta Visual Meta
        const todayCard = document.getElementById('todayCard');
        todayCard.className = gastosHoje > metaHoje ? 'card spent-today-card alert-danger' : 'card spent-today-card';

        // Progresso
        const perc = budget > 0 ? (totalGeral / budget) * 100 : 0;
        document.getElementById('progressBar').style.width = Math.min(100, perc) + '%';
        document.getElementById('progressBar').style.background = perc > 90 ? 'var(--danger)' : 'var(--success)';

        // Resumo Categorias
        let catHtml = '';
        for (let c in catsCount) catHtml += `<div class="category-item"><span>${c}</span><b>${formatter.format(catsCount[c])}</b></div>`;
        document.getElementById('catSummary').innerHTML = catHtml || 'Sem gastos.';

        // Lista de Transações
        const listEl = document.getElementById('list');
        listEl.innerHTML = '';
        let filtradas = showFullHistory ? [...transactions] : transactions.filter(t => t.date === hojeStr);
        filtradas.sort((a, b) => new Date(b.date + 'T00:00:00') - new Date(a.date + 'T00:00:00') || transactions.indexOf(b) - transactions.indexOf(a));

        filtradas.slice(0, 15).forEach(t => {
            const idx = transactions.indexOf(t);
            const li = document.createElement('li');
            li.innerHTML = `
                <div><b>${t.desc}</b><br><small>${t.category} | ${t.date.split('-').reverse().slice(0,2).join('/')}</small></div>
                <div><b>${formatter.format(t.amount)}</b> <button class="del-btn" onclick="removeTrans(${idx})">✕</button></div>
            `;
            listEl.appendChild(li);
        });

        document.getElementById('btnHistory').innerText = showFullHistory ? "Ver apenas hoje" : "Ver anteriores";
        document.getElementById('listTitle').innerText = showFullHistory ? "Histórico Recente" : "Gastos de Hoje";
        if(filtradas.length === 0) listEl.innerHTML = '<li style="justify-content:center; color:#999; border:none; padding:20px;">Tela limpa! ✨</li>';

        localStorage.setItem('financas_v10', JSON.stringify(transactions));
    }

    // --- FUNÇÕES DE CATEGORIA ---
    function toggleCatManager() {
        const el = document.getElementById('catManager');
        el.style.display = el.style.display === 'block' ? 'none' : 'block';
    }

    function addCategory() {
        const input = document.getElementById('newCatInput');
        const nova = input.value.trim();
        if (nova && !categories.includes(nova)) {
            categories.push(nova);
            input.value = '';
            updateUI();
        }
    }

    function removeCategory(index) {
        if(confirm("Remover esta categoria?")) {
            categories.splice(index, 1);
            updateUI();
        }
    }

    // --- FUNÇÕES DE TRANSAÇÃO ---
    function addTrans() {
        const desc = document.getElementById('desc').value;
        const amount = parseFloat(document.getElementById('amount').value);
        const category = document.getElementById('categorySelect').value;
        const date = document.getElementById('transDate').value;
        if (desc && amount) {
            transactions.push({ desc, amount, category, date });
            document.getElementById('desc').value = '';
            document.getElementById('amount').value = '';
            updateUI();
        }
    }

    function removeTrans(index) {
        if(confirm("Excluir registro?")) { transactions.splice(index, 1); updateUI(); }
    }

    function toggleHistory() { showFullHistory = !showFullHistory; updateUI(); }

    function toggleReport() {
        const area = document.getElementById('reportArea');
        area.style.display = area.style.display === 'block' ? 'none' : 'block';
        if (area.style.display === 'block') {
            let total = 0;
            let res = "=== EXTRATO ===\n\n";
            [...transactions].sort((a,b)=>new Date(a.date)-new Date(b.date)).forEach(t => {
                res += `${t.date.split('-').reverse().join('/')} | ${t.desc.padEnd(12)} | ${formatter.format(t.amount)}\n`;
                total += t.amount;
            });
            res += `\nTOTAL: ${formatter.format(total)}`;
            area.innerText = res;
        }
    }

    function exportCSV() {
        let csv = "Data;Categoria;Descricao;Valor\n";
        transactions.forEach(t => csv += `${t.date};${t.category};${t.desc};${t.amount}\n`);
        const blob = new Blob([csv], { type: 'text/csv' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'financas.csv';
        a.click();
    }

    function resetApp() {
        if(confirm("Zerar tudo?")) { localStorage.clear(); location.reload(); }
    }

    updateUI();
</script>
</body>
</html>
